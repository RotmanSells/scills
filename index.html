<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
<title>Ideal Body Admin</title>
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
<style>
:root {
--bg-color: #0f172a;
--surface-color: #1e293b;
--primary-massage: #8b5cf6;
--primary-laser: #ec4899;
--accent-green: #10b981;
--text-main: #f8fafc;
--text-muted: #94a3b8;
--glass: rgba(30, 41, 59, 0.7);
--glass-border: rgba(255, 255, 255, 0.1);
}
body {
background-color: var(--bg-color);
color: var(--text-main);
font-family: 'Montserrat', sans-serif;
margin: 0;
padding-bottom: 80px;
overflow-x: hidden;
-webkit-tap-highlight-color: transparent;
}
.app-header {
position: sticky;
top: 0;
z-index: 100;
background: rgba(15, 23, 42, 0.9);
backdrop-filter: blur(12px);
border-bottom: 1px solid var(--glass-border);
padding: 15px;
display: flex;
justify-content: space-between;
align-items: center;
}
.brand-title {
font-weight: 800;
font-size: 1.2rem;
background: linear-gradient(45deg, var(--primary-massage), var(--primary-laser));
-webkit-background-clip: text;
background-clip: text;
-webkit-text-fill-color: transparent;
letter-spacing: -0.5px;
}
.view-toggle {
background: var(--surface-color);
border-radius: 24px;
padding: 8px;
display: flex;
align-items: center;
gap: 0;
border: 1px solid var(--glass-border);
width: calc(100% - 20px);
margin: 10px auto;
box-sizing: border-box;
position: sticky;
top: 60px;
z-index: 99;
}
.toggle-btn {
padding: 16px 32px;
border-radius: 20px;
font-size: 1.1rem;
font-weight: 600;
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
color: var(--text-muted);
text-align: center;
cursor: pointer;
border: 2px solid var(--glass-border);
background: transparent;
flex: 1;
}
.toggle-btn.active {
background: var(--accent-green);
color: #000;
box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
border-color: var(--accent-green);
}
.toggle-btn.active-closed {
background: var(--primary-laser);
color: #fff;
box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3);
border-color: var(--primary-laser);
}
.days-container {
padding: 10px;
}
.day-block {
margin-bottom: 24px;
animation: fadeIn 0.5s ease-out;
}
.day-header {
font-size: 1.1rem;
font-weight: 700;
margin-bottom: 12px;
color: var(--text-muted);
display: flex;
align-items: center;
gap: 10px;
}
.day-header .today-badge {
background: var(--accent-green);
color: #000;
font-size: 0.7rem;
padding: 2px 8px;
border-radius: 4px;
text-transform: uppercase;
}
.slots-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
gap: 10px;
}
.time-slot {
background: var(--surface-color);
border: 1px solid var(--glass-border);
border-radius: 12px;
aspect-ratio: 1;
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
cursor: pointer;
transition: transform 0.2s, box-shadow 0.2s;
position: relative;
overflow: hidden;
}
.time-slot:active {
transform: scale(0.95);
}
.time-slot.free {
border-color: rgba(16, 185, 129, 0.3);
}
.time-slot.free .time-text {
color: var(--accent-green);
font-weight: 700;
font-size: 1.1rem;
}
.time-slot.booked {
background: #2d3748;
border-color: transparent;
}
.time-slot.booked.massage { border-left: 3px solid var(--primary-massage); }
.time-slot.booked.laser { border-left: 3px solid var(--primary-laser); }
.time-slot .client-info {
font-size: 0.7rem;
text-align: center;
margin-top: 4px;
color: var(--text-muted);
line-height: 1.2;
}
.time-slot .service-icon {
position: absolute;
top: 4px;
right: 4px;
font-size: 0.6rem;
opacity: 0.7;
}
.modal-overlay {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0,0,0,0.8);
backdrop-filter: blur(5px);
z-index: 1000;
display: none;
justify-content: center;
align-items: flex-end;
overflow: hidden;
}
.modal-overlay.active {
display: flex;
animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}
.modal-content {
background: var(--surface-color);
width: 100%;
max-width: 600px;
border-radius: 24px 24px 0 0;
padding: 20px;
box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
max-height: 90vh;
overflow-y: auto;
overflow-x: hidden;
box-sizing: border-box;
margin-bottom: 0;
display: flex;
flex-direction: column;
}
.modal-content > * {
flex-shrink: 0;
}
body.modal-open {
overflow: hidden;
position: fixed;
width: 100%;
}
.modal-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 16px;
}
.modal-title {
font-size: 1.25rem;
font-weight: 800;
}
.service-toggle {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 12px;
margin-bottom: 16px;
}
.service-btn {
padding: 16px;
border-radius: 16px;
border: 2px solid var(--glass-border);
background: transparent;
color: var(--text-muted);
font-weight: 700;
transition: all 0.2s;
cursor: pointer;
}
.service-btn.selected-massage {
background: rgba(139, 92, 246, 0.2);
border-color: var(--primary-massage);
color: var(--primary-massage);
}
.service-btn.selected-laser {
background: rgba(236, 72, 153, 0.2);
border-color: var(--primary-laser);
color: var(--primary-laser);
}
.numpad-display {
font-family: 'Roboto Mono', monospace;
font-size: 2rem;
text-align: center;
margin-bottom: 16px;
letter-spacing: 4px;
min-height: 45px;
color: var(--text-main);
border-bottom: 2px solid var(--glass-border);
}
.numpad-grid {
display: grid;
grid-template-columns: repeat(3, 1fr);
gap: 10px;
margin-bottom: 16px;
}
.num-btn {
aspect-ratio: 1.4;
border-radius: 12px;
background: rgba(255,255,255,0.05);
border: none;
font-size: 1.4rem;
color: var(--text-main);
font-weight: 500;
transition: background 0.1s;
cursor: pointer;
}
.num-btn:active { background: rgba(255,255,255,0.15); }
.num-btn.action { font-size: 1rem; color: var(--primary-laser); }
.main-action-btn {
width: 100%;
padding: 16px;
background: var(--text-main);
color: var(--bg-color);
border: none;
border-radius: 16px;
font-size: 1.1rem;
font-weight: 800;
text-transform: uppercase;
box-shadow: 0 4px 20px rgba(255,255,255,0.15);
margin-top: auto;
cursor: pointer;
}
.main-action-btn.call-btn {
background: var(--accent-green);
color: #000;
margin-bottom: 12px;
}
.main-action-btn:disabled {
opacity: 0.5;
cursor: not-allowed;
}
.settings-area textarea {
width: 100%;
height: 150px;
background: rgba(0,0,0,0.2);
border: 1px solid var(--glass-border);
color: var(--text-main);
border-radius: 12px;
padding: 12px;
font-family: monospace;
margin-bottom: 15px;
box-sizing: border-box;
}
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
#infinite-trigger {
height: 60px;
display: flex;
justify-content: center;
align-items: center;
color: var(--text-muted);
}
.loading-spinner {
width: 24px;
height: 24px;
border: 3px solid rgba(255,255,255,0.1);
border-top-color: var(--accent-green);
border-radius: 50%;
animation: spin 1s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>
<header class="app-header">
<div class="brand-title">–ò–î–ï–ê–õ–¨–ù–û–ï –¢–ï–õ–û</div>
<div onclick="App.openSettings()" style="cursor: pointer; padding: 5px;">
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
<circle cx="12" cy="12" r="3"></circle>
<path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
</svg>
</div>
</header>
<div class="view-toggle">
<div class="toggle-btn active" onclick="App.toggleView('open')">–û—Ç–∫—Ä—ã—Ç—ã–µ</div>
<div class="toggle-btn" onclick="App.toggleView('closed')">–ó–∞–∫—Ä—ã—Ç—ã–µ</div>
</div>
<main id="main-container" class="days-container">
<!-- Content injected by JS -->
</main>
<div id="infinite-trigger">
<div class="loading-spinner"></div>
</div>
<div id="booking-modal" class="modal-overlay">
<div class="modal-content">
<div class="modal-header">
<div class="modal-title" id="modal-date-title">–ó–∞–ø–∏—Å—å</div>
<div onclick="App.closeModal()" style="padding: 10px; cursor: pointer;">‚úï</div>
</div>
<div class="service-toggle">
<button class="service-btn" id="btn-massage" onclick="App.selectService('massage')">–ú–ê–°–°–ê–ñ</button>
<button class="service-btn" id="btn-laser" onclick="App.selectService('laser')">–õ–ê–ó–ï–†</button>
</div>
<div style="text-align: center; color: var(--text-muted); font-size: 0.8rem; margin-bottom: 5px;">–ü–û–°–õ–ï–î–ù–ò–ï 4 –¶–ò–§–†–´</div>
<div class="numpad-display" id="numpad-display"></div>
<div class="numpad-grid">
<button class="num-btn" onclick="App.numpadPress('1')">1</button>
<button class="num-btn" onclick="App.numpadPress('2')">2</button>
<button class="num-btn" onclick="App.numpadPress('3')">3</button>
<button class="num-btn" onclick="App.numpadPress('4')">4</button>
<button class="num-btn" onclick="App.numpadPress('5')">5</button>
<button class="num-btn" onclick="App.numpadPress('6')">6</button>
<button class="num-btn" onclick="App.numpadPress('7')">7</button>
<button class="num-btn" onclick="App.numpadPress('8')">8</button>
<button class="num-btn" onclick="App.numpadPress('9')">9</button>
<button class="num-btn action" onclick="App.numpadClear()">C</button>
<button class="num-btn" onclick="App.numpadPress('0')">0</button>
<button class="num-btn action" onclick="App.numpadBack()">‚å´</button>
</div>
<button class="main-action-btn" onclick="App.confirmBooking(); return false;" type="button">–ó–ê–ü–ò–°–ê–¢–¨</button>
</div>
</div>
<div id="view-modal" class="modal-overlay">
<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–î–µ—Ç–∞–ª–∏ –∑–∞–ø–∏—Å–∏</div>
<div onclick="App.closeModal('view-modal')" style="padding: 10px; cursor: pointer;">‚úï</div>
</div>
<div style="margin-bottom: 20px;">
<p id="view-client-phone" style="margin: 15px 0; color: var(--text-main); font-size: 1.5rem; font-weight: 600; text-align: center; font-family: 'Roboto Mono', monospace; letter-spacing: 2px; width: 100%;"></p>
<p id="view-service-info" style="margin: 15px 0; font-size: 1.1rem; font-weight: 600;"></p>
</div>
<button class="main-action-btn call-btn" id="btn-call-client" onclick="App.callClient()">–ü–û–ó–í–û–ù–ò–¢–¨</button>
<button class="main-action-btn" style="background: #ef4444; margin-top: 10px;" onclick="App.deleteBooking()">–£–î–ê–õ–ò–¢–¨ –ó–ê–ü–ò–°–¨</button>
</div>
</div>
<div id="settings-modal" class="modal-overlay">
<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
<div onclick="App.closeModal('settings-modal')" style="padding: 10px; cursor: pointer;">‚úï</div>
</div>
<h4 style="margin-bottom: 10px;">–ë–∞–∑–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤</h4>
<div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 12px; line-height: 1.5;">
<strong style="color: var(--accent-green);">üìû –í–∞–∂–Ω–æ:</strong> –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ –∫–ª–∏–µ–Ω—Ç–æ–≤, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –∑–≤–æ–Ω–∏—Ç—å –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π –∏–∑ –∑–∞–ø–∏—Å–∏.<br>
–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä–∞ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –∏–ª–∏ –ø—Ä–æ–±–µ–ª (–º–æ–∂–Ω–æ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É):
</div>
<div class="settings-area">
<textarea id="clients-input" placeholder="89001234567, 89009876543, 89005556677"></textarea>
</div>
<button class="main-action-btn" onclick="App.saveSettings()">–°–û–•–†–ê–ù–ò–¢–¨</button>
</div>
</div>
<script type="module">
/**
 * Configuration: REPLACE WITH YOUR GOOGLE SCRIPT WEB APP URL
 */
const API_URL = 'https://script.google.com/macros/s/AKfycbzLjhlGThXTM6ckk6mjgbNXVOVTDwturDVTEDnpppmDULdlvdbcpYaoL6KpLiY5GlLU/exec';

class SalonApp {
  constructor() {
    this.state = {
      view: 'open',
      bookings: [],
      clients: [],
      settings: { workStart: '10:00', workEnd: '22:00' },
      renderedDateLimit: null,
      currentBooking: null,
      viewingBooking: null,
    };
    this.isFirstRender = true;
    this.scrollObserver = null;
  }

  async init() {
    await this.loadAndPrepareData();
    this.renderUI();
    this.setupInfiniteScroll();
    this.updateToggleButtons();
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö: —Å–Ω–∞—á–∞–ª–∞ localStorage, –ø–æ—Ç–æ–º —Å–µ—Ç—å
  async loadAndPrepareData() {
    this.loadLocal();
    this.ensureDefaults();

    // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞ (–µ—Å–ª–∏ API_URL –∑–∞–¥–∞–Ω)
    if (API_URL && !API_URL.includes('YOUR_GOOGLE_SCRIPT')) {
      try {
        await this.fetchData();
      } catch (e) {
        console.warn('Failed to fetch data from server, using local state.', e);
        // –î–∞–Ω–Ω—ã–µ –∏–∑ localStorage —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
      }
    } else {
      console.warn('API_URL not configured ‚Äî local mode only.');
    }
  }

  ensureDefaults() {
    if (!this.state.settings.workStart || !this.state.settings.workEnd) {
      this.state.settings = { workStart: '10:00', workEnd: '22:00' };
    }
    if (!Array.isArray(this.state.bookings)) this.state.bookings = [];
    if (!Array.isArray(this.state.clients)) this.state.clients = [];

    if (!this.state.renderedDateLimit) {
      const d = new Date();
      d.setHours(0, 0, 0, 0);
      d.setDate(d.getDate() + 14);
      this.state.renderedDateLimit = d;
    } else if (typeof this.state.renderedDateLimit === 'string') {
      const parsed = new Date(this.state.renderedDateLimit);
      this.state.renderedDateLimit = isNaN(parsed) ? new Date() : parsed;
    }
  }

  loadLocal() {
    try {
      const s = localStorage.getItem('salon_state');
      if (s) {
        const parsed = JSON.parse(s);
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Date
        if (parsed.renderedDateLimit) {
          parsed.renderedDateLimit = new Date(parsed.renderedDateLimit);
        }
        Object.assign(this.state, parsed);
      }
    } catch (e) {
      console.error('Failed to load local state:', e);
    }
  }

  saveLocal() {
    try {
      const stateToSave = { ...this.state };
      if (stateToSave.renderedDateLimit instanceof Date) {
        stateToSave.renderedDateLimit = stateToSave.renderedDateLimit.toISOString();
      }
      localStorage.setItem('salon_state', JSON.stringify(stateToSave));
    } catch (e) {
      console.error('Failed to save local state:', e);
    }
  }

  async fetchData() {
    if (!API_URL || API_URL.includes('YOUR_GOOGLE_SCRIPT')) return;

    try {
      const res = await fetch(`${API_URL}?action=syncAll`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const json = await res.json();
      if (!json.success) throw new Error('Server sync failed');

      const data = json.data || {};
      this.state.bookings = Array.isArray(data.bookings) ? data.bookings : [];
      this.state.clients = Array.isArray(data.clients) ? data.clients : [];

      if (data.settings) {
        this.state.settings.workStart = data.settings.workStart || '10:00';
        this.state.settings.workEnd = data.settings.workEnd || '22:00';
      }

      this.saveLocal();
    } catch (e) {
      console.error('Fetch data error:', e);
      throw e;
    }
  }

  async queueAction(action, data) {
    if (!API_URL || API_URL.includes('YOUR_GOOGLE_SCRIPT')) {
      console.warn('API_URL not configured ‚Äî skipping sync');
      return { success: true, data: data, id: 'temp_' + Date.now() };
    }

    const payload = { action, ...data };
    try {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(payload),
      });

      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const text = await res.text();

      let result;
      try {
        result = JSON.parse(text);
      } catch (e) {
        result = { success: true, raw: text };
      }

      if (!result.success) {
        throw new Error('Sync action failed: ' + JSON.stringify(result));
      }

      // üîë –ö–ª—é—á–µ–≤–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –µ—Å–ª–∏ –¥–µ–π—Å—Ç–≤–∏–µ ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ, –∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª id ‚Äî –∑–∞–º–µ–Ω—è–µ–º temp ‚Üí real
      if (action === 'createBooking' && result.id && data.tempId) {
        const booking = this.state.bookings.find(b => b.id === data.tempId);
        if (booking) {
          booking.id = result.id;
        }
      }

      return result;
    } catch (err) {
      console.error('Sync error:', err, action, data);
      throw err;
    }
  }

  updateToggleButtons() {
    const btns = document.querySelectorAll('.toggle-btn');
    btns.forEach(b => {
      b.classList.remove('active', 'active-closed');
    });
    if (this.state.view === 'open') {
      btns[0]?.classList.add('active');
    } else {
      btns[1]?.classList.add('active-closed');
    }
  }

  toggleView(view) {
    this.state.view = view;
    this.updateToggleButtons();
    this.renderUI();
  }

  renderUI() {
    this.renderDays();
    this.updateInfiniteTriggerVisibility();
  }

  renderDays() {
    const container = document.getElementById('main-container');
    if (!container) return;

    container.innerHTML = '';
    this.ensureDefaults();

    const { workStart, workEnd } = this.state.settings;
    const startH = parseInt(workStart.split(':')[0]) || 10;
    const endH = parseInt(workEnd.split(':')[0]) || 22;

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const todayKey = today.toISOString().split('T')[0];
    const now = new Date();
    const currentHour = now.getHours();
    const currentMinute = now.getMinutes();

    const datesWithSlots = new Set();

    if (this.state.view === 'closed') {
      this.state.bookings
        .filter(b => b.status === 'active')
        .forEach(b => b.date && datesWithSlots.add(b.date));
    } else {
      // –û—Ç–∫—Ä—ã—Ç—ã–µ: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–Ω–∏ —Å *—Ö–æ—Ç—è –±—ã –æ–¥–Ω–∏–º —Å–≤–æ–±–æ–¥–Ω—ã–º —Å–ª–æ—Ç–æ–º*
      const endDate = new Date(this.state.renderedDateLimit);
      for (let d = new Date(today); d <= endDate; d.setDate(d.getDate() + 1)) {
        const dateKey = d.toISOString().split('T')[0];
        const isToday = dateKey === todayKey;

        let hasFreeSlot = false;
        for (let h = startH; h < endH; h++) {
          if (isToday && (h < currentHour || (h === currentHour && currentMinute > 0))) continue;
          const time = `${h}:00`;
          const booking = this.state.bookings.find(b =>
            b.date === dateKey && b.time === time && b.status === 'active'
          );
          if (!booking) {
            hasFreeSlot = true;
            break;
          }
        }
        if (hasFreeSlot) {
          datesWithSlots.add(dateKey);
        }
      }
    }

    const sortedDates = Array.from(datesWithSlots)
      .filter(d => !isNaN(new Date(d).getTime()))
      .sort();

    if (sortedDates.length === 0) {
      const emptyBlock = document.createElement('div');
      emptyBlock.className = 'day-block';
      emptyBlock.style.cssText = 'text-align: center; padding: 60px 20px; color: var(--text-muted);';
      emptyBlock.innerHTML = `
        <div style="font-size: 3rem; margin-bottom: 20px;">${this.state.view === 'closed' ? 'üìÅ' : 'üìÖ'}</div>
        <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 10px;">
          ${this.state.view === 'closed' ? '–ó–∞–∫—Ä—ã—Ç—ã—Ö –∑–∞–ø–∏—Å–µ–π –Ω–µ—Ç' : '–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤'}
        </div>
        <div style="font-size: 0.9rem;">
          ${this.state.view === 'closed' ? '–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å' : '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏'}
        </div>
      `;
      container.appendChild(emptyBlock);
    } else {
      sortedDates.forEach(dateKey => {
        const d = new Date(dateKey + 'T00:00:00');
        if (isNaN(d.getTime())) return;

        const dayStr = d.toLocaleDateString('ru-RU', { weekday: 'short', day: 'numeric', month: 'long' });
        const isToday = dateKey === todayKey;

        const dayBlock = document.createElement('div');
        dayBlock.className = 'day-block';
        dayBlock.innerHTML = `
          <div class="day-header">
            ${dayStr}
            ${isToday ? '<span class="today-badge">–°–ï–ì–û–î–ù–Ø</span>' : ''}
          </div>
          <div class="slots-grid" id="grid-${dateKey}"></div>
        `;
        container.appendChild(dayBlock);
        this.renderSlotsForDay(dateKey);
      });
    }

    // –ü–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä –ø—Ä–æ—à—ë–ª ‚Äî –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    if (this.isFirstRender) {
      this.isFirstRender = false;
      document.getElementById('infinite-trigger').style.display = 'flex';
    }
  }

  renderSlotsForDay(dateKey) {
    const container = document.getElementById(`grid-${dateKey}`);
    if (!container) return;

    const { workStart, workEnd } = this.state.settings;
    const startH = parseInt(workStart.split(':')[0]) || 10;
    const endH = parseInt(workEnd.split(':')[0]) || 22;

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const todayKey = today.toISOString().split('T')[0];
    const isToday = dateKey === todayKey;
    const now = new Date();
    const currentHour = now.getHours();
    const currentMinute = now.getMinutes();

    for (let h = startH; h < endH; h++) {
      const time = `${h}:00`;

      if (this.state.view === 'open' && isToday &&
        (h < currentHour || (h === currentHour && currentMinute > 0))) {
        continue;
      }

      const booking = this.state.bookings.find(b =>
        b.date === dateKey && b.time === time && b.status === 'active'
      );
      const isBooked = !!booking;
      const showSlot = (this.state.view === 'open' && !isBooked) ||
                       (this.state.view === 'closed' && isBooked);

      if (showSlot) {
        const slot = document.createElement('div');
        slot.className = `time-slot ${isBooked ? 'booked' : 'free'}`;
        if (isBooked) {
          slot.classList.add(booking.serviceType || 'unknown');
          const showClientName = booking.clientName && booking.clientName !== '–ù–æ–≤—ã–π';
          slot.innerHTML = `
            <div class="service-icon">${booking.serviceType === 'massage' ? 'üíÜ‚Äç‚ôÄÔ∏è' : '‚ö°'}</div>
            <div style="font-weight:700; font-size: 1rem;">${time}</div>
            ${showClientName ? `<div class="client-info">${booking.clientName}</div>` : ''}
            <div class="client-info" style="font-family:monospace">..${(booking.phone || '').slice(-4)}</div>
          `;
          slot.onclick = () => this.openViewModal(booking);
        } else {
          slot.innerHTML = `<div class="time-text">${time}</div>`;
          slot.onclick = () => this.openBookingModal(dateKey, time);
        }
        container.appendChild(slot);
      }
    }
  }

  setupInfiniteScroll() {
    const trigger = document.getElementById('infinite-trigger');
    if (!trigger) return;

    if (this.scrollObserver) {
      this.scrollObserver.disconnect();
    }

    if (this.state.view === 'closed') {
      trigger.style.display = 'none';
      return;
    }

    this.scrollObserver = new IntersectionObserver((entries) => {
      if (entries[0].isIntersecting && this.state.view === 'open') {
        this.loadMoreDays();
      }
    }, { threshold: 0.1 });

    this.scrollObserver.observe(trigger);
  }

  loadMoreDays() {
    const currentLimit = new Date(this.state.renderedDateLimit);
    const newLimit = new Date(currentLimit);
    newLimit.setDate(newLimit.getDate() + 14);
    this.state.renderedDateLimit = newLimit;
    this.saveLocal();
    this.renderUI();
  }

  updateInfiniteTriggerVisibility() {
    const trigger = document.getElementById('infinite-trigger');
    if (!trigger) return;
    trigger.style.display = this.state.view === 'closed' ? 'none' : 'flex';
  }

  // ‚Äî‚Äî‚Äî –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ ‚Äî‚Äî‚Äî

  openBookingModal(date, time) {
    this.state.currentBooking = {
      date,
      time,
      serviceType: null,
      phone: '',
      tempId: 'temp_' + Date.now(),
    };
    const d = new Date(date + 'T00:00:00');
    const dateStr = d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
    document.getElementById('modal-date-title').innerText = `${dateStr} / ${time}`;
    document.getElementById('booking-modal').classList.add('active');
    document.body.classList.add('modal-open');
    this.resetModalUI();
  }

  resetModalUI() {
    document.querySelectorAll('.service-btn').forEach(b => {
      b.classList.remove('selected-massage', 'selected-laser');
    });
    document.getElementById('numpad-display').innerText = '';
    this.updateConfirmBtn();
  }

  selectService(type) {
    if (this.state.currentBooking) {
      this.state.currentBooking.serviceType = type;
    }
    const btn1 = document.getElementById('btn-massage');
    const btn2 = document.getElementById('btn-laser');
    btn1?.classList.toggle('selected-massage', type === 'massage');
    btn2?.classList.toggle('selected-laser', type === 'laser');
    this.updateConfirmBtn();
  }

  numpadPress(num) {
    if (!this.state.currentBooking) return;
    if (this.state.currentBooking.phone.length < 4) {
      this.state.currentBooking.phone += num;
      document.getElementById('numpad-display').innerText = this.state.currentBooking.phone;
      this.updateConfirmBtn();
    }
  }

  numpadClear() {
    if (this.state.currentBooking) {
      this.state.currentBooking.phone = '';
      document.getElementById('numpad-display').innerText = '';
      this.updateConfirmBtn();
    }
  }

  numpadBack() {
    if (this.state.currentBooking) {
      this.state.currentBooking.phone = this.state.currentBooking.phone.slice(0, -1);
      document.getElementById('numpad-display').innerText = this.state.currentBooking.phone;
      this.updateConfirmBtn();
    }
  }

  updateConfirmBtn() {
    const b = this.state.currentBooking;
    const isValid = b && b.serviceType && b.phone?.length === 4;
    const btn = document.querySelector('#booking-modal .main-action-btn');
    if (btn) {
      btn.disabled = !isValid;
    }
  }

  async confirmBooking() {
    const b = this.state.currentBooking;
    if (!b || !b.serviceType || !b.phone || b.phone.length !== 4) return;

    const client = this.state.clients.find(c => {
      const phone = String(c.phone || '');
      return phone.endsWith(b.phone);
    });

    const newBooking = {
      id: b.tempId,
      date: b.date,
      time: b.time,
      serviceType: b.serviceType,
      phone: b.phone,
      clientName: client?.name || '',
      status: 'active',
      createdAt: new Date().toISOString(),
    };

    this.state.bookings.push(newBooking);
    this.saveLocal();

    this.closeModal();
    this.renderUI();

    try {
      const result = await this.queueAction('createBooking', {
        date: b.date,
        time: b.time,
        serviceType: b.serviceType,
        phone: b.phone,
        clientName: newBooking.clientName,
        tempId: b.tempId,
      });

      // üîÅ –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª id ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –∑–∞–ø–∏—Å—å
      if (result.id && result.id !== b.tempId) {
        const idx = this.state.bookings.findIndex(x => x.id === b.tempId);
        if (idx !== -1) {
          this.state.bookings[idx].id = result.id;
          this.saveLocal();
        }
      }
    } catch (e) {
      console.error('Failed to sync new booking ‚Äî keeping local copy.', e);
      // –û—Å—Ç–∞–≤–ª—è–µ–º –≤ UI ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –∑–∞–ø–∏—Å—å, –¥–∞–∂–µ –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
    }
  }

  openViewModal(booking) {
    this.state.viewingBooking = booking;
    const modal = document.getElementById('view-modal');

    let fullPhone = `...${booking.phone?.slice(-4) || '????'}`;
    const client = this.state.clients.find(c => String(c.phone || '').endsWith(booking.phone?.slice(-4)));
    if (client && client.phone) {
      fullPhone = String(client.phone);
    }

    document.getElementById('view-client-phone').innerText = fullPhone;
    document.getElementById('view-service-info').innerText = 
      booking.serviceType === 'massage' ? 'üíÜ‚Äç‚ôÄÔ∏è –ú–∞—Å—Å–∞–∂' : 
      booking.serviceType === 'laser' ? '‚ö° –õ–∞–∑–µ—Ä' : '‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';

    const callBtn = document.getElementById('btn-call-client');
    callBtn.onclick = () => {
      if (fullPhone && !fullPhone.startsWith('...')) {
        window.location.href = `tel:${fullPhone}`;
      }
    };

    modal.classList.add('active');
    document.body.classList.add('modal-open');
  }

  async deleteBooking() {
    const id = this.state.viewingBooking?.id;
    if (!id) return;

    this.state.bookings = this.state.bookings.filter(b => b.id !== id);
    this.saveLocal();

    this.closeModal('view-modal');
    this.renderUI();

    try {
      await this.queueAction('deleteBooking', { id });
    } catch (e) {
      console.error('Delete sync failed ‚Äî local state kept.', e);
    }
  }

  openSettings() {
    const phones = this.state.clients.map(c => c.phone).filter(Boolean);
    document.getElementById('clients-input').value = phones.join(', ');
    document.getElementById('settings-modal').classList.add('active');
    document.body.classList.add('modal-open');
  }

  async saveSettings() {
    const text = document.getElementById('clients-input').value;
    const newClients = [];
    const parts = text.split(/[,\s]+/).map(p => p.trim()).filter(Boolean);

    for (const part of parts) {
      const digits = part.replace(/\D/g, '');
      if (digits && digits.length >= 10) {
        newClients.push({ name: '', phone: digits, rawString: part });
      }
    }

    this.state.clients = newClients;
    this.saveLocal();
    this.closeModal('settings-modal');

    try {
      await this.queueAction('updateClients', { clients: newClients });
    } catch (e) {
      console.error('Failed to update clients on server.', e);
    }
  }

  closeModal(id = 'booking-modal') {
    document.getElementById(id)?.classList.remove('active');
    document.body.classList.remove('modal-open');
  }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
const app = new SalonApp();
window.App = app;
document.addEventListener('DOMContentLoaded', () => app.init());
</script>
</body>
</html>